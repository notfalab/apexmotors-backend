// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTH
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          Role      @default(CUSTOMER)
  avatar        String?
  loyaltyPoints Int       @default(0)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bookings      Booking[]
  reviews       Review[]
  favorites     Favorite[]
  notifications Notification[]

  @@map("users")
}

enum Role {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

// ============================================================================
// VEHICLES
// ============================================================================

model Vehicle {
  id            String    @id @default(uuid())
  name          String
  brand         String
  category      Category
  price         Float
  image         String
  images        String[]
  description   String?
  specs         Json      // { speed, acceleration, seats, fuel, transmission }
  features      String[]
  rating        Float     @default(5.0)
  reviewCount   Int       @default(0)
  isAvailable   Boolean   @default(true)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bookings      Booking[]
  reviews       Review[]
  favorites     Favorite[]
  availability  VehicleAvailability[]

  @@map("vehicles")
}

enum Category {
  SUPERCAR
  LUXURY
  SUV
  SPORTS
  CONVERTIBLE
}

model VehicleAvailability {
  id          String   @id @default(uuid())
  vehicleId   String
  date        DateTime
  isAvailable Boolean  @default(true)
  
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, date])
  @@map("vehicle_availability")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id              String        @id @default(uuid())
  bookingRef      String        @unique
  userId          String
  vehicleId       String
  
  pickupDate      DateTime
  dropoffDate     DateTime
  pickupLocation  String
  dropoffLocation String
  
  days            Int
  basePrice       Float
  extrasPrice     Float         @default(0)
  discount        Float         @default(0)
  totalPrice      Float
  
  extras          String[]      // ["chauffeur", "insurance", "gps"]
  couponCode      String?
  
  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)
  paymentIntentId String?
  
  customerNotes   String?
  adminNotes      String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id])
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id])
  payment         Payment?

  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  REFUNDED
  FAILED
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id              String        @id @default(uuid())
  bookingId       String        @unique
  stripePaymentId String?
  amount          Float
  currency        String        @default("AED")
  status          PaymentStatus @default(PENDING)
  method          String?       // "card", "apple_pay", etc.
  receiptUrl      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  booking         Booking       @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

// ============================================================================
// COUPONS
// ============================================================================

model Coupon {
  id          String      @id @default(uuid())
  code        String      @unique
  discount    Float
  type        DiscountType
  minOrder    Float       @default(0)
  maxUses     Int?
  usedCount   Int         @default(0)
  isActive    Boolean     @default(true)
  expiresAt   DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("coupons")
}

enum DiscountType {
  PERCENT
  FIXED
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id          String    @id @default(uuid())
  userId      String
  vehicleId   String
  bookingRef  String?
  rating      Int       // 1-5
  comment     String
  images      String[]
  isVerified  Boolean   @default(false)
  isApproved  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id])
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])

  @@map("reviews")
}

// ============================================================================
// EXTRAS & PACKAGES
// ============================================================================

model Extra {
  id          String    @id @default(uuid())
  name        String
  nameAr      String?
  nameRu      String?
  description String?
  price       Float
  icon        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("extras")
}

model Package {
  id          String    @id @default(uuid())
  name        String
  nameAr      String?
  nameRu      String?
  description String?
  price       Float
  image       String?
  includes    String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("packages")
}

// ============================================================================
// LOCATIONS
// ============================================================================

model Location {
  id        String    @id @default(uuid())
  name      String
  address   String
  lat       Float?
  lng       Float?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())

  @@map("locations")
}

// ============================================================================
// FAVORITES
// ============================================================================

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  vehicleId String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, vehicleId])
  @@map("favorites")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   // "booking", "payment", "promo", "system"
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================================
// SETTINGS
// ============================================================================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}
